---
title: Android请求无响应，而iOS请求通畅的典型问题
categories: 
  - Android折腾之路
excerpt: 这个问题其实是发生在两年前了，当时解决之后，没有完全整理结果。后来发现这个问题很典型，且频发，而且也有其他人也遇到此类问题。于是赶紧整理了一套解决方案，希望一样受到这种问题困扰的童鞋能够迅速解决这种问题。
date: 2017-09-04 12:09:20
tags: 
---

# 写在前面

这个问题其实是发生在两年前了，当时解决之后，没有完全整理结果。后来发现这个问题很典型，且频发，而且也有其他人也遇到此类问题。于是赶紧整理了一套解决方案，希望一样受到这种问题困扰的童鞋能够迅速解决这种问题。

# 问题现象：

```
http://xxx.xx.xxx.xxx:9080/xxxxx/user_login?name=xxx&password=xxxx&app_mac={"imei":"xxxxxxxx"}
```

上述接口为登录接口，请求时iOS返回正常，Android在各种网络中均无法成功。
经过初步的测试，get、post、带参数、不带参数、使用Android手机自带的浏览器均无法成功。

# 排查和实验：

1. PC开启一个http代理（Charles软件）进行抓包分析，发现无论手机连接了什么网络（3G4GWIFI），只要走了代理，请求必然成功。

2. 为了排除是手机网络问题，手机共享热点给PC，另一个手机通过PC代理进行请求，依然成功；

3. 手机直接连接另一个手机共享的热点，请求失败；

4. 手机连接PC共享的热点，请求失败；

**截至到此，代理的方式抓包已经无法分析问题，放弃；**

- 后来，连接上PC的热点，使用WireShark以及tcpdump进行抓包，经过对比两种请求过程（一种是代理请求，一种是直接请求），发现：

- 代理请求时，tcp三次握手正常，http通讯正常；
- 使用任意网络，取消代理进行请求，tcp只有第一次握手，也就是客户端发起建立连接的请求，但是服务端没有响应，最终超时断开连接。

综上所述，虽然现象是Android不行，iOS可以。但是从网络连接情况看，与http请求方式无关，因此与应用层无关，这看来不是修改app可以解决的问题。问题应该是出在服务器的9080端口的某些限制，也或者是进入9080端口之前的一些防火墙或者其他的入站规则限制等。感觉需要从服务端抓包调试此问题，客户端这边抓包已经尽力了~

另外，在下午5点半左右的时候，突然发现所有的网络都可以请求成功了，没有任何限制了。推测可能是服务端的规则临时做了修改。（其实后来推测应该是运营商网络的不同时间段的调整）

# 新一波排查

>过了一个星期，此问题一直无法解决，领导们着急了，要求必须全力解决。其实，我的内心是崩溃的：只在客户端排查也无能为力啊~还好找到了服务端部署人员，我们配合一起抓包。希望能对比出一个TCP包从客户端到达最终服务端究竟经历了什么变化，找出是哪一步导致TCP连接建立失败。

1. 服务器ssh过去，准备好tcpdump，抓取网卡所有数据包，做好准备；
2. 客户端同时使用tcpdump（事先使用root权限导入了Android手机），adb shell连接后，做好准备；
3. 一声令下，两边均开启tcpdump抓取，然后Android客户端发出http请求，等待超时异常产生后，终止抓包；
4. 汇总了一下我们两边的抓包数据做了对比。并没有发现什么关键性的不同（事实上TCP报文中的时间戳字段是有变化的，我们没有注意到），但是发现了一个问题，服务端nginx所在的物理机已经收到了这个网络包，但是转发给目标物理机时，超时没有收到回复。就此，我们认为，可能是转发部分有什么问题，或者目标物理机之间有什么防火墙限制； 

# 重大发现和最终解决方案

1. 经过分析后，我们发现了网上的一个相似病例，大体意思是，服务器系统的TCP参数配置了校验时间戳，而发送的TCP报文时间戳是错误的，就会自动丢弃！
2. 发现新大陆的我们马上先抓包对比Android和iOS的请求包，发现iOS发送的TCP报文中未携带时间戳字段，而Android发送的TCP报文中就会携带时间戳字段，而服务端收到的TCP报文中，Android的TCP报文中的时间戳已经变了，怀疑可能是网络通道中，比如运营商路由等操作对TCP报文的时间戳字段进行了改写，从而导致问题；而iOS的TCP报文，由于没有携带时间戳，到达服务器时，依然是没有携带时间戳的，故推断可能是运营商路由不会给未添加TCP时间戳的报文强加时间戳。这也是为什么iOS请求可以成功，而Android不可以成功。因为Android默认带了时间戳，然后就被篡改了，然后服务器收到了错误时间戳的TCP报文，直接抛弃。
3. 找到问题所在了，先从客户端进行实验。使用Android系统的设备，获取root权限，修改下面参数：
```
/proc/sys/net/ipv4/tcp_timestamps - 控制timestamp选项开启/关闭，改为0
/proc/sys/net/ipv4/tcp_tw_recycle - 减少timewait socket释放的超时时间
```
4. 修改了内核参数的Android设备，请求接口一切顺利通畅！调查到这里我们已经可以断定，iOS系统内核的TCP参数应该是配置了不开启时间戳校验的，因此发送的TCP报文中也不会携带时间戳，也不会遇到被篡改的问题，也就不会遇到被服务器丢包的问题。
5. 后来联系远端服务器运维人员，修改了服务器的内核参数，再重新使用普通Android设备测试，一切正常！

# 本文参考

其中的原理，简单的说，就是服务器系统的内核参数配置会校验时间戳，Android系统默认配置了开启，这样TCP报文就会携带时间戳，而iOS不会默认不会携带时间戳，故出现这种异常。具体原理可以参考这篇博文(http://blog.csdn.net/starean/article/details/10813367)对Linux内核代码的简单分析。
